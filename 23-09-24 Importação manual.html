<html><head><base href="https://websim.example.com/factory-stock-manager/"><title>Gerenciador de Estoque da Fábrica</title><style>
body {
  font-family: 'Roboto', sans-serif;
  margin: 0;
  padding: 0;
  background-color: #f5f7fa;
  color: #333;
}
.app-container {
  display: flex;
  height: 100vh;
}
.sidebar {
  width: 250px;
  background-color: #2c3e50;
  color: white;
  padding: 20px;
  box-shadow: 2px 0 5px rgba(0,0,0,0.1);
}
.main-title {
  color: #ecf0f1;
  font-size: 1.5em;
  margin-bottom: 20px;
  text-align: center;
  padding: 10px;
  background-color: #34495e;
  border-radius: 5px;
}
.main-content {
  flex-grow: 1;
  padding: 30px;
  overflow-y: auto;
}
h1, h2 {
  margin-bottom: 20px;
  color: #2c3e50;
}
.menu-item {
  padding: 15px;
  cursor: pointer;
  transition: all 0.3s ease;
  border-radius: 5px;
  margin-bottom: 10px;
  background-color: #34495e;
  color: #ecf0f1;
  text-align: center;
  font-weight: bold;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.menu-item:hover {
  background-color: #2c3e50;
  transform: translateY(-2px);
  box-shadow: 0 4px 6px rgba(0,0,0,0.15);
}
.stock-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 25px;
}
.stock-item, .producao-item {
  background-color: white;
  border-radius: 10px;
  padding: 20px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}
.stock-item:hover, .producao-item:hover {
  transform: translateY(-5px);
  box-shadow: 0 6px 8px rgba(0,0,0,0.15);
}
.add-item-btn {
  position: fixed;
  bottom: 30px;
  right: 30px;
  background-color: #3498db;
  color: white;
  border: none;
  border-radius: 50%;
  width: 60px;
  height: 60px;
  font-size: 24px;
  cursor: pointer;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}
.add-item-btn:hover {
  background-color: #2980b9;
  transform: scale(1.1);
}
.modal {
  display: none;
  position: fixed;
  z-index: 1;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
  animation: fadeIn 0.3s ease;
}
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
.modal-content {
  background-color: #fefefe;
  margin: 5% auto;
  padding: 30px;
  border: none;
  width: 80%;
  max-width: 600px;
  border-radius: 10px;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}
.close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  transition: color 0.3s ease;
}
.close:hover,
.close:focus {
  color: #2c3e50;
}
form {
  display: flex;
  flex-direction: column;
}
input, select {
  margin-bottom: 15px;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 5px;
  font-size: 16px;
}
button[type="submit"] {
  background-color: #3498db;
  color: white;
  border: none;
  padding: 12px;
  cursor: pointer;
  border-radius: 5px;
  font-size: 16px;
  transition: background-color 0.3s ease;
}
button[type="submit"]:hover {
  background-color: #2980b9;
}
table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0 10px;
  margin-top: 20px;
}
th, td {
  padding: 12px;
  text-align: left;
  background-color: white;
}
th {
  background-color: #f2f2f2;
  font-weight: bold;
}
tr {
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}
tr:hover {
  transform: translateY(-3px);
  box-shadow: 0 4px 6px rgba(0,0,0,0.15);
}
input[type="number"] {
  width: 100%;
  box-sizing: border-box;
}
.tab-content {
  display: none;
  animation: fadeIn 0.5s ease;
}
.filters {
  margin-bottom: 20px;
  display: flex;
  gap: 10px;
}
.filters select {
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 5px;
  font-size: 16px;
  flex-grow: 1;
}
.loja-info {
  background-color: white;
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}
.loja-info:hover {
  transform: translateY(-5px);
  box-shadow: 0 6px 8px rgba(0,0,0,0.15);
}
.custom-select {
  position: relative;
  margin-bottom: 15px;
}
.custom-select input {
  width: 100%;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 5px;
  font-size: 16px;
}
.custom-select ul {
  position: absolute;
  width: 100%;
  max-height: 200px;
  overflow-y: auto;
  list-style-type: none;
  padding: 0;
  margin: 0;
  border: 1px solid #ddd;
  border-top: none;
  border-radius: 0 0 5px 5px;
  background-color: white;
  display: none;
  z-index: 1;
}
.custom-select ul li {
  padding: 10px;
  cursor: pointer;
}
.custom-select ul li:hover {
  background-color: #f0f0f0;
}
.chart-container {
  width: 100%;
  height: 300px;
  margin-bottom: 20px;
}
.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
}
#lojasTable {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}
#lojasTable th, #lojasTable td {
  padding: 10px;
  border: 1px solid #ddd;
  text-align: left;
}
#lojasTable th {
  background-color: #f2f2f2;
  font-weight: bold;
}
#lojasTable tr:nth-child(even) {
  background-color: #f9f9f9;
}
#lojasTable tr:hover {
  background-color: #f5f5f5;
}
</style><script src="https://cdn.jsdelivr.net/npm/chart.js"></script></head><body>
<div class="app-container">
  <div class="sidebar">
    <h1 class="main-title">Controle de Estoque MK</h1>
    <h2>Gerenciador de Estoque</h2>
    <nav>
      <div class="menu-item" data-tab="dashboard">Dashboard</div>
      <div class="menu-item" data-tab="pedidos">Pedidos</div>
      <div class="menu-item" data-tab="estoque">Estoque</div>
      <div class="menu-item" data-tab="producao">Produção/Entrada</div>
      <div class="menu-item" data-tab="historicoPedidos">Histórico Pedidos</div>
      <div class="menu-item" data-tab="previsao">Previsão</div>
      <div class="menu-item" data-tab="lojas">Lojas</div>
    </nav>
  </div>
  <div class="main-content">
    <div id="dashboard" class="tab-content">
      <h1>Dashboard</h1>
      <div class="dashboard-grid"></div>
    </div>
    <div id="pedidos" class="tab-content">
      <h1>Pedidos</h1>
      <div class="filters">
        <select id="filtroUnidade">
          <option value="">Todas as Unidades</option>
        </select>
        <select id="filtroRegiao">
          <option value="">Todas as Regiões</option>
        </select>
      </div>
      <div class="summary">
        <p>Total de Pedidos: 0</p>
        <p>Unidades: </p>
        <p>Regiões: </p>
        <p>Lojas: </p>
        <h2>Total de Produtos por Loja:</h2>
      </div>
    </div>
    <div id="estoque" class="tab-content">
      <h1>Estoque</h1>
      <h2>Capitão Gourmet</h2>
      <table>
        <thead>
          <tr>
            <th>Produto</th>
            <th>Quantidade em Estoque</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
      <h2>Brasília</h2>
      <table>
        <thead>
          <tr>
            <th>Produto</th>
            <th>Quantidade em Estoque</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
      <h2>Recife</h2>
      <table>
        <thead>
          <tr>
            <th>Produto</th>
            <th>Quantidade em Estoque</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
      <h2>Maria Fruta</h2>
      <table>
        <thead>
          <tr>
            <th>Produto</th>
            <th>Quantidade em Estoque</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
      <h2>WIW</h2>
      <table>
        <thead>
          <tr>
            <th>Produto</th>
            <th>Quantidade em Estoque</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>
    <div id="producao" class="tab-content">
      <h1>Produção/Entrada</h1>
      <!-- Add producao content here -->
    </div>
    <div id="historicoPedidos" class="tab-content">
      <h1>Histórico Pedidos</h1>
      <div class="stock-grid" id="pedidosGrid">
        <!-- New stock items (pedidos) will be dynamically added here -->
      </div>
    </div>
    <div id="previsao" class="tab-content">
      <h1>Previsão</h1>
      <!-- Content will be dynamically added here -->
    </div>
    <div id="lojas" class="tab-content">
      <h1>Lojas</h1>
      <table id="lojasTable">
        <thead>
          <tr>
            <th>Nome da Loja</th>
          </tr>
        </thead>
        <tbody>
          <!-- Table content will be dynamically added here -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<button class="add-item-btn" id="addItemBtn">+</button>

<div id="addItemModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>Nova Adição</h2>
    <form id="addItemForm">
      <select id="tipoEntrada">
        <option value="">Selecione o Tipo</option>
        <option value="Produção/Entrada">Produção/Entrada</option>
        <option value="Pedidos">Pedidos</option>
      </select>
      <div id="pedidosFields" style="display: none;">
        <div class="custom-select">
          <input type="text" id="lojaSearch" placeholder="Pesquisar loja...">
          <ul id="lojaOptions"></ul>
        </div>
        <select id="unidade">
          <option value="">Unidade</option>
        </select>
        <select id="regiao">
          <option value="">Região</option>
        </select>
      </div>
      <input type="date" id="data">
      <table id="productTable">
        <thead>
          <tr>
            <th>Produto</th>
            <th>Quantidade</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>Frango</td><td><input type="number" name="quantidade" id="firstQuantityInput" min="0"></td></tr>
          <tr><td>Português</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Calabresa</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Margherita</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Brócolis</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Maxi Beef</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Peito de Peru</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Frango Catupiry</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Quatro Queijos</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Vegano</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Filet Mignon com Cheddar</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Kalzone com Galak</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Calabresa Catupiry</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Chocolate</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Frango, Cheddar e Bacon</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Camarão Catupiry</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Frango & Palmito</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Kalzone com Nutella</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Carne Seca Especial</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Smoothie Tá ligado (polpinha)</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Smoothie Sem Noção</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Smoothie Irado</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Smoothie Daora</td><td><input type="number" name="quantidade" min="0"></td></tr>
          <tr><td>Smoothie Tá Ligado (1 kg)</td><td><input type="number" name="quantidade" min="0"></td></tr>
        </tbody>
      </table>
      <button type="submit">Adicionar</button>
    </form>
  </div>
</div>

<script>
let stockItems = [];
let stockChart = null;
let currentStock = {
  "Capitão Gourmet": {},
  "Brasília": {},
  "Recife": {},
  "Maria Fruta": {},
  "WIW": {}
};

const regioesPorUnidade = {
  "Capitão Gourmet": ["Grande Florianópolis", "Rota SC", "Rota Norte SC", "Rota Sul SC+RS", "Rota SP+PR+MA+MS"],
  "Brasília": ["Rota Centro-Oeste"],
  "Recife": ["Rota Nordeste"],
  "Maria Fruta": ["Maria Fruta"],
  "WIW": ["WIW"]
};

const lojasPorRegiao = {
  "Grande Florianópolis": [
    "UFSC", "Anita", "Felipe Schimidt", "Kobrasol", "Itaguaçu", "Via Catarina",
    "Capitão Gourmet", "Trindade", "Lagoa", "Floripa Shopping", "Imbituba",
    "Beira Mar", "Mk Coqueiros", "Continente Shopping", "Angeloni Capoeiras",
    "Angeloni Beira Mar", "Forquilhas", "Jardim Cidade", "Palhoça", "Estreito",
    "Pinheira", "Deodoro", "Ingleses", "Garopaba", "Rio Tavares", "Barreiros",
    "Praia Comprida", "Guarda Do Embaú", "Pedra Branca", "Tijucas", "Laguna",
    "Villa Romana", "Campeche", "Biguaçu", "Santo Amaro", "Campo Duna"
  ],
  "Rota SC": [
    "Concórdia", "Chapecó", "Joaçaba", "Braço Do Norte", "Rio Do Sul"
  ],
  "Rota Norte SC": [
    "Blumenau Neumarkt", "Blumenau Park Shopping", "Mueller Joinville", "Garten Joinville",
    "Blumenau Norte Shopping", "Balneário Shopping", "Jaraguá Do Sul Park Shopping", "Itajaí",
    "Joinville Guanabara", "Balneário Camelódromo", "São Francisco Do Sul", "Meia Praia Itapema",
    "Joinville Centro", "Jaraguá Centro", "Balneário Rua", "Brusque", "Itajaí Rua",
    "Blumenau Rua", "Camboriú Rua", "Komprão Itapema", "Unisociesc"
  ],
  "Rota Sul SC+RS": [
    "Tubarão SC", "Shopping Total Porto Alegre", "Canoas RS", "Bourbon Shopping Caxias", "Cachoeirinha RS",
    "Criciúma SC", "Pelotas Shopping", "Gravataí RS", "Lages SC", "Cachoeirinha Rua",
    "Araranguá", "Criciúma Nações", "Iguatemi POA", "São Leopoldo", "Novo Hamburgo",
    "Canoas Park", "Villagio Caxias", "Barra Shop. POA", "Passo Fundo", "PUC",
    "Pelotas Centro Andrade Neves", "Tubarão Drive", "Vacaria", "Lages Rua", "Nh Outlet",
    "Oasis", "Pelotas Drive Avenida Bento Gonçalves", "Cachoeira Do Sul", "POA Galeria Chaves", "Praia De Belas"
  ],
  "Rota SP+PR+MA+MS": [
    "Curitiba PR", "Estação Curitiba PR", "Barueri SP", "Campo Grande MS",
    "Bauru SP", "Cascavel PR", "Guarapuava", "Ponta Grossa PR",
    "Shopping Da Ilha MA", "Rio Anil MA", "BH MG", "Contagem MG"
  ],
  "Rota Centro-Oeste": [
    "Taguatinga DF", "Bramk Pátio Brasil DF", "Conjunto Nacional DF", "Anashoping",
    "Anápolis GO", "Valparaíso GO", "Alameda DF", "Jk DF", "Aparecida De Goiania",
    "Park Shopping", "Recanto", "Carrefour GO", "Águas Claras DF", "Águas Lindas"
  ],
  "Rota Nordeste": [
    "Tacaruna", "Boa Vista", "Guararapes", "Mangabeira", "Maceió", "Manaíra", "Recife"
  ],
  "Maria Fruta": ["Maria Fruta"],
  "WIW": ["WIW"]
};

const allLojas = Object.values(lojasPorRegiao).flat();

function updateStock(item) {
  const unit = item.unidade || "Capitão Gourmet"; // Default to Capitão Gourmet if no unit specified
  for (const [produto, quantidade] of Object.entries(item.produtos)) {
    if (!currentStock[unit][produto]) {
      currentStock[unit][produto] = 0;
    }
    if (item.tipoEntrada === 'Produção/Entrada') {
      currentStock[unit][produto] += quantidade;
    } else if (item.tipoEntrada === 'Pedidos') {
      currentStock[unit][produto] -= quantidade;
    }
  }
}

function calculatePredictedStock() {
  const predictedStock = {};
  const averageConsumption = {};
  const idealStock = {};

  for (const [unit, stock] of Object.entries(currentStock)) {
    averageConsumption[unit] = {};
    idealStock[unit] = {};
    for (const [product, quantity] of Object.entries(stock)) {
      averageConsumption[unit][product] = Math.round(quantity * 0.1);
      idealStock[unit][product] = quantity + averageConsumption[unit][product];
    }
  }

  for (const [unit, stock] of Object.entries(currentStock)) {
    predictedStock[unit] = {};
    for (const [product, quantity] of Object.entries(stock)) {
      predictedStock[unit][product] = idealStock[unit][product] - quantity;
    }
  }

  return predictedStock;
}

function renderPrevisaoTab() {
  const previsaoTab = document.getElementById('previsao');
  const predictedStock = calculatePredictedStock();

  let previsaoHTML = '<h1>Previsão</h1>';

  for (const [unit, stock] of Object.entries(predictedStock)) {
    previsaoHTML += `<h2>${unit}</h2>`;
    previsaoHTML += '<table><thead><tr><th>Produto</th><th>Produção/Entrada Ideal</th></tr></thead><tbody>';
    
    for (const [produto, quantidade] of Object.entries(stock)) {
      previsaoHTML += `<tr><td>${produto}</td><td>${quantidade}</td></tr>`;
    }
    
    previsaoHTML += '</tbody></table>';
  }

  previsaoTab.innerHTML = previsaoHTML;
}

function updateDashboardChart() {
  const dashboardDiv = document.getElementById('dashboard');
  dashboardDiv.innerHTML = '<h1>Dashboard</h1><div class="dashboard-grid"></div>';
  const dashboardGrid = dashboardDiv.querySelector('.dashboard-grid');

  for (const [unit, stock] of Object.entries(currentStock)) {
    const chartContainer = document.createElement('div');
    chartContainer.className = 'chart-container';
    const chartCanvas = document.createElement('canvas');
    chartCanvas.id = `${unit.replace(/\s+/g, '')}Chart`;
    chartContainer.appendChild(chartCanvas);
    dashboardGrid.appendChild(chartContainer);

    const ctx = chartCanvas.getContext('2d');
    const products = Object.entries(stock);

    const averageStock = products.reduce((sum, [, qty]) => sum + qty, 0) / products.length;

    const getColor = (quantity) => {
      if (quantity < averageStock * 0.3) return 'rgba(255, 99, 132, 0.6)';
      if (quantity > averageStock * 1.7) return 'rgba(255, 159, 64, 0.6)';
      return 'rgba(75, 192, 192, 0.6)';
    };

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: products.map(item => item[0]),
        datasets: [{
          label: `Products in ${unit}`,
          data: products.map(item => item[1]),
          backgroundColor: products.map(item => getColor(item[1])),
          borderColor: products.map(item => getColor(item[1]).replace('0.6', '1')),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true
          },
          x: {
            ticks: {
              autoSkip: false,
              maxRotation: 90,
              minRotation: 90
            }
          }
        },
        plugins: {
          legend: {
            display: false
          },
          title: {
            display: true,
            text: unit,
            font: {
              size: 16,
              weight: 'bold'
            }
          },
          tooltip: {
            callbacks: {
              title: function(context) {
                return context[0].label;
              },
              label: function(context) {
                return `Quantity: ${context.parsed.y}`;
              }
            }
          }
        }
      }
    });
  }

  const pieChartContainer = document.createElement('div');
  pieChartContainer.className = 'chart-container';
  const pieChartCanvas = document.createElement('canvas');
  pieChartCanvas.id = 'stockDistributionChart';
  pieChartContainer.appendChild(pieChartCanvas);
  dashboardGrid.appendChild(pieChartContainer);

  const pieCtx = pieChartCanvas.getContext('2d');
  const unitTotals = Object.entries(currentStock).map(([unit, stock]) => ({
    unit,
    total: Object.values(stock).reduce((sum, qty) => sum + qty, 0)
  }));

  const totalStock = unitTotals.reduce((sum, item) => sum + item.total, 0);

  new Chart(pieCtx, {
    type: 'pie',
    data: {
      labels: unitTotals.map(item => item.unit),
      datasets: [{
        data: unitTotals.map(item => item.total),
        backgroundColor: [
          'rgba(255, 99, 132, 0.6)',
          'rgba(54, 162, 235, 0.6)',
          'rgba(255, 206, 86, 0.6)',
          'rgba(75, 192, 192, 0.6)',
          'rgba(153, 102, 255, 0.6)'
        ]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: true,
          text: [`Distribuição do Estoque Total`, `Total: ${totalStock}`],
          font: {
            size: 16,
            weight: 'bold'
          }
        }
      }
    }
  });
}

function applyFilters() {
  const selectedUnidade = document.getElementById('filtroUnidade').value;
  const selectedRegiao = document.getElementById('filtroRegiao').value;
  
  const lojaInfoDivs = document.querySelectorAll('.loja-info');
  
  lojaInfoDivs.forEach(div => {
    const unidade = div.dataset.unidade;
    const regiao = div.dataset.regiao;
    
    const unidadeMatch = !selectedUnidade || unidade === selectedUnidade;
    const regiaoMatch = !selectedRegiao || regiao === selectedRegiao;
    
    if (unidadeMatch && regiaoMatch) {
      div.style.display = 'block';
    } else {
      div.style.display = 'none';
    }
  });
}

function renderStockItems() {
  const pedidosGrid = document.getElementById('pedidosGrid');
  if (pedidosGrid) {
    pedidosGrid.innerHTML = '';
  }
  
  const summary = {
    totalPedidos: 0,
    totalProdutosPorLoja: {},
    unidades: new Set(),
    regioes: new Set(),
    lojas: new Set(),
    lojaInfo: {}
  };
  
  stockItems.forEach(item => {
    const stockItemElement = document.createElement('div');
    stockItemElement.className = 'stock-item';
    stockItemElement.innerHTML = `
      <h3>${item.unidade}</h3>
      <p>Região: ${item.regiao}</p>
      <p>Loja: ${item.loja || 'N/A'}</p>
      <p>Data: ${item.data}</p>
      <p>Tipo: ${item.tipoEntrada}</p>
      <ul>
        ${Object.entries(item.produtos).map(([produto, quantidade]) => 
          `<li>${produto}: ${quantidade}</li>`
        ).join('')}
      </ul>
    `;
    if (item.isPedido && pedidosGrid) {
      pedidosGrid.appendChild(stockItemElement);
      
      summary.totalPedidos++;
      summary.unidades.add(item.unidade);
      summary.regioes.add(item.regiao);
      summary.lojas.add(item.loja);
      
      summary.lojaInfo[item.loja] = {
        unidade: item.unidade,
        regiao: item.regiao
      };

      if (!summary.totalProdutosPorLoja[item.loja]) {
        summary.totalProdutosPorLoja[item.loja] = {};
      }
      
      Object.entries(item.produtos).forEach(([produto, quantidade]) => {
        summary.totalProdutosPorLoja[item.loja][produto] = (summary.totalProdutosPorLoja[item.loja][produto] || 0) + quantidade;
      });
    }
  });
  
  const pedidosTab = document.getElementById('pedidos');
  if (pedidosTab) {
    let produtosHTML = '';
    
    const filtroUnidade = document.getElementById('filtroUnidade');
    const filtroRegiao = document.getElementById('filtroRegiao');
    
    filtroUnidade.innerHTML = '<option value="">Todas as Unidades</option>';
    filtroRegiao.innerHTML = '<option value="">Todas as Regiões</option>';
    
    Array.from(summary.unidades).forEach(unidade => {
      filtroUnidade.innerHTML += `<option value="${unidade}">${unidade}</option>`;
    });
    
    Array.from(summary.regioes).forEach(regiao => {
      filtroRegiao.innerHTML += `<option value="${regiao}">${regiao}</option>`;
    });

    produtosHTML += '<h2>Total de Produtos por Loja:</h2>';
    for (const [loja, produtos] of Object.entries(summary.totalProdutosPorLoja)) {
      const lojaInfo = summary.lojaInfo[loja] || { unidade: 'N/A', regiao: 'N/A' };
      produtosHTML += `
        <div class="loja-info" data-unidade="${lojaInfo.unidade}" data-regiao="${lojaInfo.regiao}">
          <h3>${loja}</h3>
          <p>Unidade: ${lojaInfo.unidade}, Região: ${lojaInfo.regiao}</p>
          <ul>
            ${Object.entries(produtos).map(([produto, quantidade]) => 
              `<li>${produto}: ${quantidade}</li>`
            ).join('')}
          </ul>
        </div>
      `;
    }
    
    pedidosTab.innerHTML = `
      <h1>Pedidos</h1>
      <div class="filters">
        <select id="filtroUnidade">
          <option value="">Todas as Unidades</option>
          ${Array.from(summary.unidades).map(unidade => `<option value="${unidade}">${unidade}</option>`).join('')}
        </select>
        <select id="filtroRegiao">
          <option value="">Todas as Regiões</option>
          ${Array.from(summary.regioes).map(regiao => `<option value="${regiao}">${regiao}</option>`).join('')}
        </select>
      </div>
      <div class="summary">
        <p>Total de Pedidos: ${summary.totalPedidos}</p>
        <p>Unidades: ${Array.from(summary.unidades).join(', ')}</p>
        <p>Regiões: ${Array.from(summary.regioes).join(', ')}</p>
        <p>Lojas: ${Array.from(summary.lojas).join(', ')}</p>
        ${produtosHTML}
      </div>
    `;

    document.getElementById('filtroUnidade').addEventListener('change', applyFilters);
    document.getElementById('filtroRegiao').addEventListener('change', applyFilters);
  }

  const productionItems = stockItems.filter(item => item.tipoEntrada === 'Produção/Entrada');
  renderProducaoEntradaTab(productionItems);
  renderEstoqueTab(); 
  updateDashboardChart(); 
}

function switchTab(tabName) {
  const tabs = document.querySelectorAll('.tab-content');
  tabs.forEach(tab => tab.style.display = 'none');
  document.getElementById(tabName).style.display = 'block';
  
  if (tabName === 'dashboard') {
    updateDashboardChart();
  } else if (tabName === 'previsao') {
    renderPrevisaoTab();
  } else if (tabName === 'lojas') {
    renderLojasTab();
  }
}

function renderEstoqueTab() {
  const estoqueTab = document.getElementById('estoque');
  if (estoqueTab) {
    let estoqueHTML = '<h1>Estoque</h1>';
    
    for (const [unit, stock] of Object.entries(currentStock)) {
      estoqueHTML += `<h2>${unit}</h2>`;
      estoqueHTML += '<table><thead><tr><th>Produto</th><th>Quantidade em Estoque</th></tr></thead><tbody>';
      
      for (const [produto, quantidade] of Object.entries(stock)) {
        estoqueHTML += `<tr><td>${produto}</td><td>${quantidade}</td></tr>`;
      }
      
      estoqueHTML += '</tbody></table>';
    }
    
    estoqueTab.innerHTML = estoqueHTML;
  }
}

function renderLojasTab() {
  const lojasTableBody = document.querySelector('#lojasTable tbody');
  lojasTableBody.innerHTML = '';
  
  allLojas.sort().forEach(loja => {
    const row = document.createElement('tr');
    const cell = document.createElement('td');
    cell.textContent = loja;
    row.appendChild(cell);
    lojasTableBody.appendChild(row);
  });
}

function renderProducaoEntradaTab(productionItems) {
  const producaoTab = document.getElementById('producao');
  if (producaoTab) {
    let producaoHTML = '<h1>Produção/Entrada</h1>';
    
    const groupedByDate = {};
    productionItems.forEach(item => {
      if (!groupedByDate[item.data]) {
        groupedByDate[item.data] = [];
      }
      groupedByDate[item.data].push(item);
    });

    const sortedDates = Object.keys(groupedByDate).sort();

    sortedDates.forEach(date => {
      producaoHTML += `<h2>${date}</h2>`;
      groupedByDate[date].forEach(item => {
        producaoHTML += `
          <div class="producao-item">
            <h3>Produção/Entrada</h3>
            <ul>
              ${Object.entries(item.produtos).map(([produto, quantidade]) => 
                `<li>${produto}: ${quantidade}</li>`
              ).join('')}
            </ul>
          </div>
        `;
      });
    });

    producaoTab.innerHTML = producaoHTML;
  }
}

const modal = document.getElementById('addItemModal');
const btn = document.getElementById('addItemBtn');
const span = document.getElementsByClassName('close')[0];
const unidadeSelect = document.getElementById('unidade');
const regiaoSelect = document.getElementById('regiao');
const tipoEntradaSelect = document.getElementById('tipoEntrada');
const pedidosFields = document.getElementById('pedidosFields');
const lojaSearch = document.getElementById('lojaSearch');
const lojaOptions = document.getElementById('lojaOptions');
let currentLojas = [];

btn.onclick = function() {
  modal.style.display = "block";
}

span.onclick = function() {
  modal.style.display = "none";
}

window.onclick = function(event) {
  if (event.target == modal) {
    modal.style.display = "none";
  }
}

tipoEntradaSelect.addEventListener('change', function() {
  if (this.value === 'Pedidos') {
    pedidosFields.style.display = 'block';
    document.getElementById('productTable').style.display = 'table';
    document.querySelector('.custom-select').style.display = 'block';
    unidadeSelect.style.display = 'block';
    regiaoSelect.style.display = 'block';
    populateLojaOptions(allLojas);
  } else if (this.value === 'Produção/Entrada') {
    pedidosFields.style.display = 'block';
    document.getElementById('productTable').style.display = 'table';
    unidadeSelect.style.display = 'block';
    regiaoSelect.style.display = 'none';
    document.querySelector('.custom-select').style.display = 'none';
    populateUnidadeOptions();
  } else {
    pedidosFields.style.display = 'none';
    document.getElementById('productTable').style.display = 'none';
  }
});

function populateUnidadeOptions() {
  unidadeSelect.innerHTML = '<option value="">Selecione a Unidade</option>';
  Object.keys(regioesPorUnidade).forEach(unidade => {
    unidadeSelect.innerHTML += `<option value="${unidade}">${unidade}</option>`;
  });
}

function populateLojaOptions(lojas) {
  lojaOptions.innerHTML = '';
  lojas.forEach(loja => {
    const li = document.createElement('li');
    li.textContent = loja;
    li.addEventListener('click', () => {
      lojaSearch.value = loja;
      lojaOptions.style.display = 'none';
      autoFillUnidadeRegiao(loja);
    });
    lojaOptions.appendChild(li);
  });
}

function autoFillUnidadeRegiao(selectedLoja) {
  for (const [unidade, regioes] of Object.entries(regioesPorUnidade)) {
    for (const regiao of regioes) {
      if (lojasPorRegiao[regiao] && lojasPorRegiao[regiao].includes(selectedLoja)) {
        unidadeSelect.innerHTML = Object.keys(regioesPorUnidade).map(u => `<option value="${u}">${u}</option>`).join('');
        unidadeSelect.value = unidade;
        
        regiaoSelect.innerHTML = regioes.map(r => `<option value="${r}">${r}</option>`).join('');
        regiaoSelect.value = regiao;
        return;
      }
    }
  }
}

lojaSearch.addEventListener('input', function() {
  const searchTerm = this.value.toLowerCase();
  const filteredLojas = allLojas.filter(loja => 
    loja.toLowerCase().includes(searchTerm)
  );
  populateLojaOptions(filteredLojas);
  lojaOptions.style.display = 'block';
});

lojaSearch.addEventListener('focus', () => {
  lojaOptions.style.display = 'block';
});

document.addEventListener('click', (e) => {
  if (!lojaSearch.contains(e.target) && !lojaOptions.contains(e.target)) {
    lojaOptions.style.display = 'none';
  }
});

document.getElementById('addItemForm').addEventListener('submit', function(e) {
  e.preventDefault();

  const newItem = {
    tipoEntrada: document.getElementById('tipoEntrada').value,
    data: document.getElementById('data').value,
    produtos: {},
    isPedido: document.getElementById('tipoEntrada').value === 'Pedidos'
  };

  if (newItem.isPedido) {
    newItem.loja = lojaSearch.value;
    newItem.unidade = unidadeSelect.value;
    newItem.regiao = regiaoSelect.value;
  } else if (newItem.tipoEntrada === 'Produção/Entrada') {
    newItem.unidade = unidadeSelect.value;
  }

  const quantidadeInputs = document.querySelectorAll('#productTable input[name="quantidade"]');
  const produtoNames = document.querySelectorAll('#productTable td:first-child');

  quantidadeInputs.forEach((input, index) => {
    const quantidade = parseInt(input.value) || 0;
    if (quantidade > 0) {
      newItem.produtos[produtoNames[index].textContent] = quantidade;
    }
  });

  if (Object.values(newItem).some(value => value !== '' && value !== null && value !== undefined) || Object.keys(newItem.produtos).length > 0) {
    stockItems.push(newItem);
    updateStock(newItem);  
    renderStockItems();
    renderEstoqueTab();  
    modal.style.display = "none";
    this.reset();
    
    switchTab(newItem.isPedido ? 'historicoPedidos' : 'producao');
  } else {
    alert('Por favor, preencha pelo menos um campo antes de salvar.');
  }
});

function switchTab(tabName) {
  const tabs = document.querySelectorAll('.tab-content');
  tabs.forEach(tab => tab.style.display = 'none');
  document.getElementById(tabName).style.display = 'block';
  
  if (tabName === 'dashboard') {
    updateDashboardChart();
  } else if (tabName === 'previsao') {
    renderPrevisaoTab();
  } else if (tabName === 'lojas') {
    renderLojasTab();
  }
}

document.querySelectorAll('.menu-item').forEach(item => {
  item.addEventListener('click', function() {
    switchTab(this.dataset.tab);
  });
});

// Initialize with Dashboard tab
updateDashboardChart();
renderLojasTab();

function handlePaste(e) {
  e.preventDefault();
  const pastedData = e.clipboardData.getData('text').split('\n');
  const quantityInputs = document.querySelectorAll('#productTable input[name="quantidade"]');
  
  quantityInputs.forEach((input, index) => {
    if (pastedData[index]) {
      input.value = pastedData[index].trim();
    }
  });
}

document.getElementById('firstQuantityInput').addEventListener('paste', handlePaste);

renderStockItems();

</script>
</body></html>